# #!/bin/bash

# # Retry function
# retry() {
#   local n=1
#   local max_attempts=3
#   local delay=5
#   while true; do
#     "$@" && break || {
#       if [[ $n -lt $max_attempts ]]; then
#         ((n++))
#         echo "Command failed. Attempt $n/$max_attempts:"
#         sleep $delay;
#       else
#         echo "The command has failed after $n attempts."
#         return 1
#       fi
#     }
#   done
# }

# # installs NVM (Node Version Manager)
# retry curl -o- https://raw.githubusercontent.com/nvm-sh/nvm/v0.39.7/install.sh | bash

# # add the following to your .bashrc or .bash_profile
# export NVM_DIR="$HOME/.nvm"
# retry [ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"  # This loads nvm
# retry [ -s "$NVM_DIR/bash_completion" ] && \. "$NVM_DIR/bash_completion"  # This loads nvm bash_completion

# # download and install Node.js
# retry nvm install 20

# # verifies the right Node.js version is in the environment
# retry node -v # should print `v20.12.2`
# # verifies the right NPM version is in the environment
# retry npm -v # should print `10.5.0`

# # Install PM2 
# retry npm install pm2 -g


# # Chnage dir
# cd /var

# # Clone git repo
# retry git clone https://github.com/daucu/daucu.git

# # Goto frontend
# cd /var/daucu/frontend

# # Install frontend dependencies
# retry npm install

# # Build frontend
# retry npm run build

# # Run in pm2
# retry pm2 start npm --name "frontend" -- start

# # Start PM2 on boot
# retry pm2 startup

# # Save PM2
# retry pm2 save



#!/bin/bash

# Retry function
retry() {
  local n=1
  local max_attempts=3
  local delay=5
  while true; do
    "$@" && break || {
      if [[ $n -lt $max_attempts ]]; then
        ((n++))
        echo "Command failed. Attempt $n/$max_attempts:"
        sleep $delay;
      else
        echo "The command has failed after $n attempts."
        return 1
      fi
    }
  done
}

# Update system
retry sudo apt-get update -y
retry sudo apt-get upgrade -y

# Install Docker
retry sudo apt-get install -y docker.io

# Start Docker service
retry sudo systemctl start docker
retry sudo systemctl enable docker

# Initialize Docker Swarm
retry sudo docker swarm init

# Create Traefik configuration file
cat <<EOF | sudo tee ./traefik.yml
api:
  insecure: true
  dashboard: true

entryPoints:
  web:
    address: ":80"
  websecure:
    address: ":443"

providers:
  docker:
    endpoint: "unix:///var/run/docker.sock"
    exposedByDefault: false

log:
  level: DEBUG
EOF

# Create Docker Compose file for Traefik
cat <<EOF | sudo tee docker-compose.yml
version: "3"

services:
  traefik:
    image: traefik:v3.0
    container_name: traefik
    ports:
      - "80:80" # The HTTP port
      - "443:443" # The HTTPS port
      - "8080:8080" # The Web UI (enabled by --api.insecure=true)
    volumes:
      - "/var/run/docker.sock:/var/run/docker.sock:ro" # So that Traefik can listen to the Docker events
      - "./traefik.yml:/traefik.yml:ro"
    command:
      - "--configFile=/traefik.yml"
EOF

# Deploy Traefik stack using Docker Compose
retry sudo docker stack deploy -c docker-compose.yml traefik

# Deploy daucu_frontend service
retry sudo docker service create \
  --name daucu_frontend \
  --publish 3000:3000 \
  --restart-condition any \
  --restart-delay 5s \
  --restart-max-attempts 3 \
  --restart-window 120s \
  daucu/daucu_frontend

# Create a Docker Compose file for MongoDB with a different name (mongo-stack.yml)
cat <<EOF > mongo-stack.yml
version: '3.8'

services:
  mongo:
    image: mongo:latest
    ports:
      - 27017:27017
    volumes:
      - mongo-data:/data/db
    environment:
      MONGO_INITDB_ROOT_USERNAME: root
      MONGO_INITDB_ROOT_PASSWORD: example

volumes:
  mongo-data:
EOF

# Deploy the stack using Docker Swarm with the specified file name
retry sudo docker stack deploy -c mongo-stack.yml mongo_stack

# Download Go executable
retry curl -Lo /usr/local/bin/daucu_backend https://get.daucu.com/backend/main

# Make the executable file executable
sudo chmod +x /usr/local/bin/daucu_backend

# Create systemd service file for the Go executable
cat <<EOF | sudo tee /etc/systemd/system/daucu_backend.service
[Unit]
Description=Daucu Backend Service
After=network.target

[Service]
Type=simple
ExecStart=/usr/local/bin/daucu_backend
Restart=on-failure

[Install]
WantedBy=multi-user.target
EOF

# Reload systemd to recognize the new service
retry sudo systemctl daemon-reload

# Enable and start the new service
retry sudo systemctl enable daucu_backend
retry sudo systemctl start daucu_backend

echo "Setup completed successfully!"

# Output the message to browse to the frontend
echo "Setup completed successfully! You can browse the application at http://your_public_ip:3000"
