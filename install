# #!/bin/bash

# # Retry function
# retry() {
#   local n=1
#   local max_attempts=3
#   local delay=5
#   while true; do
#     "$@" && break || {
#       if [[ $n -lt $max_attempts ]]; then
#         ((n++))
#         echo "Command failed. Attempt $n/$max_attempts:"
#         sleep $delay;
#       else
#         echo "The command has failed after $n attempts."
#         return 1
#       fi
#     }
#   done
# }

# # installs NVM (Node Version Manager)
# retry curl -o- https://raw.githubusercontent.com/nvm-sh/nvm/v0.39.7/install.sh | bash

# # add the following to your .bashrc or .bash_profile
# export NVM_DIR="$HOME/.nvm"
# retry [ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"  # This loads nvm
# retry [ -s "$NVM_DIR/bash_completion" ] && \. "$NVM_DIR/bash_completion"  # This loads nvm bash_completion

# # download and install Node.js
# retry nvm install 20

# # verifies the right Node.js version is in the environment
# retry node -v # should print `v20.12.2`
# # verifies the right NPM version is in the environment
# retry npm -v # should print `10.5.0`

# # Install PM2 
# retry npm install pm2 -g


# # Chnage dir
# cd /var

# # Clone git repo
# retry git clone https://github.com/daucu/daucu.git

# # Goto frontend
# cd /var/daucu/frontend

# # Install frontend dependencies
# retry npm install

# # Build frontend
# retry npm run build

# # Run in pm2
# retry pm2 start npm --name "frontend" -- start

# # Start PM2 on boot
# retry pm2 startup

# # Save PM2
# retry pm2 save



#!/bin/bash

# Retry function
retry() {
  local n=1
  local max_attempts=3
  local delay=5
  while true; do
    "$@" && break || {
      if [[ $n -lt $max_attempts ]]; then
        ((n++))
        echo "Command failed. Attempt $n/$max_attempts:"
        sleep $delay;
      else
        echo "The command has failed after $n attempts."
        return 1
      fi
    }
  done
}

# Update system
retry sudo apt-get update
retry sudo apt-get upgrade -y

# Install Docker
retry sudo apt-get install -y docker.io

# Start Docker service
retry sudo systemctl start docker
retry sudo systemctl enable docker

# Run frontend Docker image
retry sudo docker run -d --name daucu_frontend -p 3000:3000 --restart always daucu/daucu_frontend

# Download Go executable
retry curl -o /usr/local/bin/daucu_backend https://get.daucu.com/backend/main

# Make the executable file executable
sudo chmod +x /usr/local/bin/daucu_backend

# Create systemd service file for the Go executable
cat <<EOF | sudo tee /etc/systemd/system/daucu_backend.service
[Unit]
Description=Daucu Backend Service
After=network.target

[Service]
Type=simple
ExecStart=/usr/local/bin/daucu_backend
Restart=on-failure

[Install]
WantedBy=multi-user.target
EOF

# Reload systemd to recognize the new service
retry sudo systemctl daemon-reload

# Enable and start the new service
retry sudo systemctl enable daucu_backend
retry sudo systemctl start daucu_backend

echo "Setup completed successfully!"

# Get the server's IP address
IP_ADDRESS=$(hostname -I | awk '{print $1}')

# Output the message to browse to the frontend
echo "Setup completed successfully! You can browse the application at http://$IP_ADDRESS:3000"
