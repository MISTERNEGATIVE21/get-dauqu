#!/bin/bash

# Retry function with parameterized attempts and delay
retry() {
  local max_attempts=${2:-3}
  local delay=${3:-5}
  local n=1
  while true; do
    "$1" && break || {
      if [[ $n -lt $max_attempts ]]; then
        ((n++))
        echo "Command failed. Attempt $n/$max_attempts:"
        sleep $delay
      else
        echo "The command has failed after $max_attempts attempts."
        return 1
      fi
    }
  done
}

# Load NVM and dependencies
load_nvm() {
  export NVM_DIR="$HOME/.nvm"
  [ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"  # This loads nvm
  [ -s "$NVM_DIR/bash_completion" ] && \. "$NVM_DIR/bash_completion"  # This loads nvm bash_completion
}

# Function to install and configure Node.js
install_node() {
  retry "nvm install 20" 3 10
  retry "node -v | grep 'v20.12.2'" 3 5
  retry "npm -v | grep '10.5.0'" 3 5
}

# Main function to manage installation and setup
main() {
  # installs NVM (Node Version Manager)
  retry "curl -o- https://raw.githubusercontent.com/nvm-sh/nvm/v0.39.7/install.sh | bash" 3 5
  load_nvm
  install_node

  # Install PM2 globally
  retry "npm install pm2 -g" 3 10

  local repo_dir="/var/daucu"

  # Ensure the directory exists and is accessible
  mkdir -p "$repo_dir"
  cd "$repo_dir" || { echo "Failed to change directory to $repo_dir"; exit 1; }

  # Clone git repo
  retry "git clone https://github.com/daucu/daucu.git" 3 10

  # Change to frontend directory
  cd "${repo_dir}/frontend" || { echo "Failed to change directory to ${repo_dir}/frontend"; exit 1; }

  # Install frontend dependencies and build
  retry "npm install" 3 10
  retry "npm run build" 3 10

  # Run frontend in pm2
  pm2 start npm --name "frontend" -- start

  # Setup PM2 to start on boot and save the PM2 state
  pm2 startup
  pm2 save
}

# Run the main function
main
